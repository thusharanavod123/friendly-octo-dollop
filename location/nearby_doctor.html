<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Doctors</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        #map {
            height: 400px; /* Adjust the height as needed */
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>Find Nearby Doctors</h1>
    <div id="map"></div>
    <div id="doctorsList"></div>

    <script>
       
        //(getDistance function)
        //Input: Latitude and longitude of two points on Earth.
        //Output: Distance between those two points in kilometers.(circular distance)

        //lat1 - user latitude, lat2- doctor latitude
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                0.5 - Math.cos(dLat) / 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                (1 - Math.cos(dLon)) / 2;

            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function getNearbyDoctors(latitude, longitude) {
            $.ajax({
                url: 'get_nearby_doctors.php',
                type: 'POST',
                data: {
                    latitude: latitude,
                    longitude: longitude
                },
                success: function (response) {
                    const doctors = JSON.parse(response);
                    const doctorsList = $('#doctorsList');
                    doctorsList.empty();

                    doctors.forEach(doctor => {
                        const distance = getDistance(latitude, longitude, doctor.latitude, doctor.longitude);
                        if (distance <= 15) { // Adjust the distance threshold as needed
                            doctorsList.append(`<p>${doctor.name} - ${distance.toFixed(2)} km away</p>`);
                            
                            // Add marker to the map
                            L.marker([doctor.latitude, doctor.longitude]).addTo(map)
                                .bindPopup(`${doctor.name} - ${distance.toFixed(2)} km away`)
                                .openPopup();
                        }
                    });
                }
            });
        }

        // Initialize the map
        let map = L.map('map').setView([0, 0], 13); // Default center, will be updated with user's location

        // Load and display tile layers on the map (OpenStreetMap tiles)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        $(document).ready(function () {
            // Create a custom red marker icon
        const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', // Red marker icon
        iconSize: [25, 41], // size of the icon
        iconAnchor: [12, 41], // point of the icon which will correspond to marker's location
        popupAnchor: [1, -34], // point from which the popup should open relative to the iconAnchor
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', // URL for the shadow image
        shadowSize: [41, 41] // size of the shadow
        });
        if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // Update the map center to the user's location
                    map.setView([latitude, longitude], 13);

                    // Add a marker for the user's current location
                    L.marker([latitude, longitude], { icon: redIcon }).addTo(map)
                        .bindPopup("You are here!")
                        .openPopup();

                    getNearbyDoctors(latitude, longitude);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });
    </script>
</body>

</html>
